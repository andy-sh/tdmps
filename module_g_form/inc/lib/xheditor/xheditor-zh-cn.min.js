(function($,undefined){if(window.xheditor)return false;var agent=navigator.userAgent.toLowerCase();var bMobile=agent.indexOf("mobile")!==-1,browser=$.browser,browerVer=parseFloat(browser.version),isIE=browser.msie,isMozilla=browser.mozilla,isSafari=browser.safari,isOpera=browser.opera;var bAir=agent.indexOf(" adobeair/")>-1;var bIOS5=/OS 5(_\d)+ like Mac OS X/i.test(agent);$.fn.xheditor=function(options){if(bMobile&&!bIOS5)return false;var arrSuccess=[];this.each(function(){if(!$.nodeName(this,"TEXTAREA"))return;if(options===false){if(this.xheditor){this.xheditor.remove();this.xheditor=null}}else{if(!this.xheditor){var tOptions=/({.*})/.exec($(this).attr("class"));if(tOptions){try{tOptions=eval("("+tOptions[1]+")")}catch(ex){}options=$.extend({},tOptions,options)}var editor=new xheditor(this,options);if(editor.init()){this.xheditor=editor;arrSuccess.push(editor)}else editor=null}else arrSuccess.push(this.xheditor)}});if(arrSuccess.length===0)arrSuccess=false;if(arrSuccess.length===1)arrSuccess=arrSuccess[0];return arrSuccess};var xCount=0,bShowPanel=false,bClickCancel=true,bShowModal=false,bCheckEscInit=false;var _jPanel,_jShadow,_jCntLine,_jPanelButton;var jModal,jModalShadow,layerShadow,jOverlay,jHideSelect,onModalRemove;var editorRoot;$("script[src*=xheditor]").each(function(){var e=this.src;if(e.match(/xheditor[^\/]*\.js/i)){editorRoot=e.replace(/[\?#].*$/,"").replace(/(^|[\/\\])[^\/]*$/,"$1");return false}});if(isIE){try{document.execCommand("BackgroundImageCache",false,true)}catch(e){}var jqueryVer=$.fn.jquery;if(jqueryVer&&jqueryVer.match(/^1\.[67]/))$.attrHooks["width"]=$.attrHooks["height"]=null}var specialKeys={27:"esc",9:"tab",32:"space",13:"enter",8:"backspace",145:"scroll",20:"capslock",144:"numlock",19:"pause",45:"insert",36:"home",46:"del",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12"};var itemColors=["#FFFFFF","#CCCCCC","#C0C0C0","#999999","#666666","#333333","#000000","#FFCCCC","#FF6666","#FF0000","#CC0000","#990000","#660000","#330000","#FFCC99","#FF9966","#FF9900","#FF6600","#CC6600","#993300","#663300","#FFFF99","#FFFF66","#FFCC66","#FFCC33","#CC9933","#996633","#663333","#FFFFCC","#FFFF33","#FFFF00","#FFCC00","#999900","#666600","#333300","#99FF99","#66FF99","#33FF33","#33CC00","#009900","#006600","#003300","#99FFFF","#33FFFF","#66CCCC","#00CCCC","#339999","#336666","#003333","#CCFFFF","#66FFFF","#33CCFF","#3366FF","#3333FF","#000099","#000066","#CCCCFF","#9999FF","#6666CC","#6633FF","#6600CC","#333399","#330099","#FFCCFF","#FF99FF","#CC66CC","#CC33CC","#993399","#663366","#330033"];var arrBlocktag=[{n:"p",t:"普通段落"},{n:"h1",t:"标题1"},{n:"h2",t:"标题2"},{n:"h3",t:"标题3"},{n:"h4",t:"标题4"},{n:"h5",t:"标题5"},{n:"h6",t:"标题6"},{n:"pre",t:"已编排格式"},{n:"address",t:"地址"}];var arrFontname=[{n:"宋体",c:"SimSun"},{n:"仿宋体",c:"FangSong_GB2312"},{n:"黑体",c:"SimHei"},{n:"楷体",c:"KaiTi_GB2312"},{n:"微软雅黑",c:"Microsoft YaHei"},{n:"Arial"},{n:"Arial Black"},{n:"Comic Sans MS"},{n:"Courier New"},{n:"System"},{n:"Times New Roman"},{n:"Tahoma"},{n:"Verdana"}];var arrFontsize=[{n:"x-small",s:"10px",t:"极小"},{n:"small",s:"12px",t:"特小"},{n:"medium",s:"16px",t:"小"},{n:"large",s:"18px",t:"中"},{n:"x-large",s:"24px",t:"大"},{n:"xx-large",s:"32px",t:"特大"},{n:"-webkit-xxx-large",s:"48px",t:"极大"}];var menuAlign=[{s:"左对齐",v:"justifyleft"},{s:"居中",v:"justifycenter"},{s:"右对齐",v:"justifyright"},{s:"两端对齐",v:"justifyfull"}],menuList=[{s:"数字列表",v:"insertOrderedList"},{s:"符号列表",v:"insertUnorderedList"}];var htmlPastetext='<div><label for="xhePastetextValue">使用键盘快捷键(Ctrl+V)把内容粘贴到方框里，按 确定</label></div><div><textarea id="xhePastetextValue" wrap="soft" spellcheck="false" style="width:300px;height:100px;" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>';var htmlLink='<div><label for="xheLinkUrl">链接地址: </label><input type="text" id="xheLinkUrl" value="http://" class="xheText" /></div><div><label for="xheLinkTarget">打开方式: </label><select id="xheLinkTarget"><option selected="selected" value="">默认</option><option value="_blank">新窗口</option><option value="_self">当前窗口</option><option value="_parent">父窗口</option></select></div><div style="display:none"><label for="xheLinkText">链接文字: </label><input type="text" id="xheLinkText" value="" class="xheText" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>';var htmlAnchor='<div><label for="xheAnchorName">锚点名称: </label><input type="text" id="xheAnchorName" value="" class="xheText" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>';var htmlImg='<div><label for="xheImgUrl">图片文件: </label><input type="text" id="xheImgUrl" value="http://" class="xheText" /></div><div><div><label for="xheImgAlt">替换文本: </label><input type="text" id="xheImgAlt" /></div><div><label for="xheImgAlign">对齐方式: </label><select id="xheImgAlign"><option selected="selected" value="">默认</option><option value="left">左对齐</option><option value="right">右对齐</option><option value="top">顶端</option><option value="middle">居中</option><option value="baseline">基线</option><option value="bottom">底边</option></select></div><div><label for="xheImgWidth">宽　　度: </label><input type="text" id="xheImgWidth" style="width:40px;" /> <label for="xheImgHeight">高　　度: </label><input type="text" id="xheImgHeight" style="width:40px;" /></div><div><label for="xheImgBorder">边框大小: </label><input type="text" id="xheImgBorder" style="width:40px;" /></div><div><label for="xheImgHspace">水平间距: </label><input type="text" id="xheImgHspace" style="width:40px;" /> <label for="xheImgVspace">垂直间距: </label><input type="text" id="xheImgVspace" style="width:40px;" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>';var htmlFlash='<div><label for="xheFlashUrl">动画文件: </label><input type="text" id="xheFlashUrl" value="http://" class="xheText" /></div><div><label for="xheFlashWidth">宽　　度: </label><input type="text" id="xheFlashWidth" style="width:40px;" value="480" /> <label for="xheFlashHeight">高　　度: </label><input type="text" id="xheFlashHeight" style="width:40px;" value="400" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>';var htmlMedia='<div><label for="xheMediaUrl">媒体文件: </label><input type="text" id="xheMediaUrl" value="http://" class="xheText" /></div><div><label for="xheMediaWidth">宽　　度: </label><input type="text" id="xheMediaWidth" style="width:40px;" value="480" /> <label for="xheMediaHeight">高　　度: </label><input type="text" id="xheMediaHeight" style="width:40px;" value="400" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>';var htmlTable='<div><label for="xheTableRows">行　　数: </label><input type="text" id="xheTableRows" style="width:40px;" value="3" /> <label for="xheTableColumns">列　　数: </label><input type="text" id="xheTableColumns" style="width:40px;" value="2" /></div><div><label for="xheTableHeaders">标题单元: </label><select id="xheTableHeaders"><option selected="selected" value="">无</option><option value="row">第一行</option><option value="col">第一列</option><option value="both">第一行和第一列</option></select></div><div><label for="xheTableWidth">宽　　度: </label><input type="text" id="xheTableWidth" style="width:40px;" value="200" /> <label for="xheTableHeight">高　　度: </label><input type="text" id="xheTableHeight" style="width:40px;" value="" /></div><div><label for="xheTableBorder">边框大小: </label><input type="text" id="xheTableBorder" style="width:40px;" value="1" /></div><div><label for="xheTableCellSpacing">表格间距: </label><input type="text" id="xheTableCellSpacing" style="width:40px;" value="1" /> <label for="xheTableCellPadding">表格填充: </label><input type="text" id="xheTableCellPadding" style="width:40px;" value="1" /></div><div><label for="xheTableAlign">对齐方式: </label><select id="xheTableAlign"><option selected="selected" value="">默认</option><option value="left">左对齐</option><option value="center">居中</option><option value="right">右对齐</option></select></div><div><label for="xheTableCaption">表格标题: </label><input type="text" id="xheTableCaption" /></div><div style="text-align:right;"><input type="button" id="xheSave" value="确定" /></div>';var htmlAbout='<div style="font:12px Arial;width:245px;word-wrap:break-word;word-break:break-all;outline:none;" role="dialog" tabindex="-1"><p><span style="font-size:20px;color:#1997DF;">xhEditor</span><br />v1.1.14 (build 120701)</p><p>xhEditor是基于jQuery开发的跨平台轻量可视化XHTML编辑器，基于<a href="http://www.gnu.org/licenses/lgpl.html" target="_blank">LGPL</a>开源协议发布。</p><p>Copyright &copy; <a href="http://xheditor.com/" target="_blank">xhEditor.com</a>. All rights reserved.</p></div>';var itemEmots={"default":{name:"默认",width:24,height:24,line:7,list:{smile:"微笑",tongue:"吐舌头",titter:"偷笑",laugh:"大笑",sad:"难过",wronged:"委屈",fastcry:"快哭了",cry:"哭",wail:"大哭",mad:"生气",knock:"敲打",curse:"骂人",crazy:"抓狂",angry:"发火",ohmy:"惊讶",awkward:"尴尬",panic:"惊恐",shy:"害羞",cute:"可怜",envy:"羡慕",proud:"得意",struggle:"奋斗",quiet:"安静",shutup:"闭嘴",doubt:"疑问",despise:"鄙视",sleep:"睡觉",bye:"再见"}}};var arrTools={Cut:{t:"剪切 (Ctrl+X)"},Copy:{t:"复制 (Ctrl+C)"},Paste:{t:"粘贴 (Ctrl+V)"},Pastetext:{t:"粘贴文本",h:isIE?0:1},Blocktag:{t:"段落标签",h:1},Fontface:{t:"字体",h:1},FontSize:{t:"字体大小",h:1},Bold:{t:"加粗 (Ctrl+B)",s:"Ctrl+B"},Italic:{t:"斜体 (Ctrl+I)",s:"Ctrl+I"},Underline:{t:"下划线 (Ctrl+U)",s:"Ctrl+U"},Strikethrough:{t:"删除线"},FontColor:{t:"字体颜色",h:1},BackColor:{t:"背景颜色",h:1},SelectAll:{t:"全选 (Ctrl+A)"},Removeformat:{t:"删除文字格式"},Align:{t:"对齐",h:1},List:{t:"列表",h:1},Outdent:{t:"减少缩进"},Indent:{t:"增加缩进"},Link:{t:"超链接 (Ctrl+L)",s:"Ctrl+L",h:1},Unlink:{t:"取消超链接"},Anchor:{t:"锚点",h:1},Img:{t:"图片",h:1},Flash:{t:"Flash动画",h:1},Media:{t:"多媒体文件",h:1},Hr:{t:"插入水平线"},Emot:{t:"表情",s:"ctrl+e",h:1},Table:{t:"表格",h:1},Source:{t:"源代码"},Preview:{t:"预览"},Print:{t:"打印 (Ctrl+P)",s:"Ctrl+P"},Fullscreen:{t:"全屏编辑 (Esc)",s:"Esc"},About:{t:"关于 xhEditor"}};var toolsThemes={mini:"Bold,Italic,Underline,Strikethrough,|,Align,List,|,Link,Img",simple:"Blocktag,Fontface,FontSize,Bold,Italic,Underline,Strikethrough,FontColor,BackColor,|,Align,List,Outdent,Indent,|,Link,Img,Emot",full:"Cut,Copy,Paste,Pastetext,|,Blocktag,Fontface,FontSize,Bold,Italic,Underline,Strikethrough,FontColor,BackColor,SelectAll,Removeformat,|,Align,List,Outdent,Indent,|,Link,Unlink,Anchor,Img,Flash,Media,Hr,Emot,Table,|,Source,Preview,Print,Fullscreen"};toolsThemes.mfull=toolsThemes.full.replace(/\|(,Align)/i,"/$1");var arrDbClick={a:"Link",img:"Img",embed:"Embed"},uploadInputname="filedata";var arrEntities={"<":"&lt;",">":"&gt;",'"':"&quot;","®":"&reg;","©":"&copy;"};var regEntities=/[<>"®©]/g;var xheditor=function(textarea,options){function checkDblClick(e){var t=e.target,n=arrDbClick[t.tagName.toLowerCase()];if(n){if(n==="Embed"){var r={"application/x-shockwave-flash":"Flash","application/x-mplayer2":"Media"};n=r[t.type.toLowerCase()]}_this.exec(n)}}function checkEsc(e){if(e.which===27){if(bShowModal)_this.removeModal();else if(bShowPanel)_this.hidePanel();return false}}function loadReset(){setTimeout(_this.setSource,10)}function saveResult(){_this.getSource()}function cleanPaste(e){var t,n,r;if(e&&(t=e.originalEvent.clipboardData)&&(n=t.items)&&(r=n[0])&&r.kind=="file"&&r.type.match(/^image\//i)){var i=r.getAsFile(),s=new FileReader;s.onload=function(){var e='<img src="'+event.target.result+'">';e=replaceRemoteImg(e);_this.pasteHTML(e)};s.readAsDataURL(i);return false}var o=settings.cleanPaste;if(o===0||bSource||bCleanPaste)return true;bCleanPaste=true;_this.saveBookmark();var u=isIE?"pre":"div",a=$("<"+u+' class="xhe-paste">﻿﻿</'+u+">",_doc).appendTo(_doc.body),f=a[0],l=_this.getSel(),c=_this.getRng(true);a.css("top",_jWin.scrollTop());if(isIE){c.moveToElementText(f);c.select()}else{c.selectNodeContents(f);l.removeAllRanges();l.addRange(c)}setTimeout(function(){var e=o===3,t;if(e)t=a.text();else{var n=$(".xhe-paste",_doc.body),r=[];n.each(function(e,t){if($(t).find(".xhe-paste").length==0)r.push(t.innerHTML)});t=r.join("<br />")}a.remove();_this.loadBookmark();t=t.replace(/^[\s\uFEFF]+|[\s\uFEFF]+$/g,"");if(t){if(e)_this.pasteText(t);else{t=_this.cleanHTML(t);t=_this.cleanWord(t);t=_this.formatXHTML(t);if(!settings.onPaste||settings.onPaste&&(t=settings.onPaste(t))!==false){t=replaceRemoteImg(t);_this.pasteHTML(t)}}}bCleanPaste=false},0)}function replaceRemoteImg(e){var t=settings.localUrlTest,n=settings.remoteImgSaveUrl;if(t&&n){var r=[],i=0;e=e.replace(/(<img)((?:\s+[^>]*?)?(?:\s+src="\s*([^"]+)\s*")(?: [^>]*)?)(\/?>)/ig,function(e,n,s,o,u){if(/^(https?|data:image)/i.test(o)&&!/_xhe_temp/.test(s)&&!t.test(o)){r[i]=o;s=s.replace(/\s+(width|height)="[^"]*"/ig,"").replace(/\s+src="[^"]*"/ig,' src="'+skinPath+'img/waiting.gif" remoteimg="'+i++ +'"')}return n+s+u});if(r.length>0){$.post(n,{urls:r.join("|")},function(e){e=e.split("|");$("img[remoteimg]",_this.doc).each(function(){var t=$(this);xheAttr(t,"src",e[t.attr("remoteimg")]);t.removeAttr("remoteimg")})})}}return e}function setCSS(e){try{_this._exec("styleWithCSS",e,true)}catch(t){try{_this._exec("useCSS",!e,true)}catch(t){}}}function setOpts(){if(bInit&&!bSource){setCSS(false);try{_this._exec("enableObjectResizing",true,true)}catch(e){}if(isIE)try{_this._exec("BackgroundImageCache",true,true)}catch(e){}}}function forcePtag(e){if(bSource||e.which!==13||e.shiftKey||e.ctrlKey||e.altKey)return true;var t=_this.getParent("p,h1,h2,h3,h4,h5,h6,pre,address,div,li");if(t.is("li"))return true;if(settings.forcePtag){if(t.length===0)_this._exec("formatblock","<p>")}else{_this.pasteHTML("<br />");if(isIE&&t.length>0&&_this.getRng().parentElement().childNodes.length===2)_this.pasteHTML("<br />");return false}}function fixFullHeight(){if(!isMozilla&&!isSafari){if(bFullscreen)_jArea.height("100%").css("height",_jArea.outerHeight()-_jTools.outerHeight());if(isIE)_jTools.hide().show()}}function fixAppleSel(e){e=e.target;if(e.tagName.match(/(img|embed)/i)){var t=_this.getSel(),n=_this.getRng(true);n.selectNode(e);t.removeAllRanges();t.addRange(n)}}function xheAttr(e,t,n){if(!t)return false;var r="_xhe_"+t;if(n){if(urlType)n=getLocalUrl(n,urlType,urlBase);e.attr(t,urlBase?getLocalUrl(n,"abs",urlBase):n).removeAttr(r).attr(r,n)}return e.attr(r)||e.attr(t)}function clickCancelPanel(){if(bClickCancel)_this.hidePanel()}function checkShortcuts(e){if(bSource)return true;var t=e.which,n=specialKeys[t],r=n?n:String.fromCharCode(t).toLowerCase();sKey="";sKey+=e.ctrlKey?"ctrl+":"";sKey+=e.altKey?"alt+":"";sKey+=e.shiftKey?"shift+":"";sKey+=r;var i=arrShortCuts[sKey],s;for(s in i){s=i[s];if($.isFunction(s)){if(s.call(_this)===false)return false}else{_this.exec(s);return false}}}function is(e,t){var n=typeof e;if(!t)return n!="undefined";if(t==="array"&&e.hasOwnProperty&&e instanceof Array)return true;return n===t}function getLocalUrl(e,t,n){if(e.match(/^(\w+):\/\//i)&&!e.match(/^https?:/i)||/^#/i.test(e)||/^data:/i.test(e))return e;var r=n?$('<a href="'+n+'" />')[0]:location,i=r.protocol,s=r.host,o=r.hostname,u=r.port,a=r.pathname.replace(/\\/g,"/").replace(/[^\/]+$/i,"");if(u==="")u="80";if(a==="")a="/";else if(a.charAt(0)!=="/")a="/"+a;e=$.trim(e);if(t!=="abs")e=e.replace(new RegExp(i+"\\/\\/"+o.replace(/\./g,"\\.")+"(?::"+u+")"+(u==="80"?"?":"")+"(/|$)","i"),"/");if(t==="rel")e=e.replace(new RegExp("^"+a.replace(/([\/\.\+\[\]\(\)])/g,"\\$1"),"i"),"");if(t!=="rel"){if(!e.match(/^(https?:\/\/|\/)/i))e=a+e;if(e.charAt(0)==="/"){var f=[],l=e.split("/"),c,h,p=l.length;for(h=0;h<p;h++){c=l[h];if(c==="..")f.pop();else if(c!==""&&c!==".")f.push(c)}if(l[p-1]==="")f.push("");e="/"+f.join("/")}}if(t==="abs"&&!e.match(/^https?:\/\//i))e=i+"//"+s+e;e=e.replace(/(https?:\/\/[^:\/?#]+):80(\/|$)/i,"$1$2");return e}function checkFileExt(e,t){if(t==="*"||e.match(new RegExp(".("+t.replace(/,/g,"|")+")$","i")))return true;else{alert("上传文件扩展名必需为: "+t);return false}}function formatBytes(e){var t=["Byte","KB","MB","GB","TB","PB"];var n=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,Math.floor(n))).toFixed(2)+t[n]}function returnFalse(){return false}var _this=this,_text=textarea,_jText=$(_text),_jForm=_jText.closest("form"),_jTools,_jArea,_win,_jWin,_doc,_jDoc;var bookmark;var bInit=false,bSource=false,bFullscreen=false,bCleanPaste=false,outerScroll,bShowBlocktag=false,sLayoutStyle="",ev=null,timer,bDisableHoverExec=false,bQuickHoverExec=false;var lastPoint=null,lastAngle=null;var editorHeight=0;var settings=_this.settings=$.extend({},xheditor.settings,options);var plugins=settings.plugins,strPlugins=[];if(plugins){arrTools=$.extend({},arrTools,plugins);$.each(plugins,function(e){strPlugins.push(e)});strPlugins=strPlugins.join(",")}if(settings.tools.match(/^\s*(m?full|simple|mini)\s*$/i)){var toolsTheme=toolsThemes[$.trim(settings.tools)];settings.tools=settings.tools.match(/m?full/i)&&plugins?toolsTheme.replace("Table","Table,"+strPlugins):toolsTheme}settings.tools=settings.tools.split(",");if(settings.editorRoot)editorRoot=settings.editorRoot;if(bAir===false)editorRoot=getLocalUrl(editorRoot,"abs");if(settings.urlBase)settings.urlBase=getLocalUrl(settings.urlBase,"abs");var idCSS="xheCSS_"+settings.skin,idContainer="xhe"+xCount+"_container",idTools="xhe"+xCount+"_Tool",idIframeArea="xhe"+xCount+"_iframearea",idIframe="xhe"+xCount+"_iframe",idFixFFCursor="xhe"+xCount+"_fixffcursor";var headHTML="",bodyClass="",skinPath=editorRoot+"xheditor_skin/"+settings.skin+"/",arrEmots=itemEmots,urlType=settings.urlType,urlBase=settings.urlBase,emotPath=settings.emotPath,emotPath=emotPath?emotPath:editorRoot+"xheditor_emot/",selEmotGroup="";arrEmots=$.extend({},arrEmots,settings.emots);emotPath=getLocalUrl(emotPath,"rel",urlBase?urlBase:null);bShowBlocktag=settings.showBlocktag;if(bShowBlocktag)bodyClass+=" showBlocktag";var arrShortCuts=[];this.init=function(){if($("#"+idCSS).length===0)$("head").append('<link id="'+idCSS+'" rel="stylesheet" type="text/css" href="'+skinPath+'ui.css" />');var e=_jText.outerWidth(),t=_jText.outerHeight();var n=settings.width||_text.style.width||(e>10?e:0);editorHeight=settings.height||_text.style.height||(t>10?t:150);if(is(n,"number"))n+="px";if(is(editorHeight,"string"))editorHeight=editorHeight.replace(/[^\d]+/g,"");var r=settings.background||_text.style.background;var i=['<span class="xheGStart"/>'],s,o,u=/\||\//i;$.each(settings.tools,function(e,t){if(t.match(u))i.push('<span class="xheGEnd"/>');if(t==="|")i.push('<span class="xheSeparator"/>');else if(t==="/")i.push("<br />");else{s=arrTools[t];if(!s)return;if(s.c)o=s.c;else o="xheIcon xheBtn"+t;i.push('<span><a href="#" title="'+s.t+'" cmd="'+t+'" class="xheButton xheEnabled" tabindex="-1" role="button"><span class="'+o+'" unselectable="on" style="font-size:0;color:transparent;text-indent:-999px;">'+s.t+"</span></a></span>");if(s.s)_this.addShortcuts(s.s,t)}if(t.match(u))i.push('<span class="xheGStart"/>')});i.push('<span class="xheGEnd"/><br />');_jText.after($('<input type="text" id="'+idFixFFCursor+'" style="position:absolute;display:none;" /><span id="'+idContainer+'" class="xhe_'+settings.skin+'" style="display:none"><table cellspacing="0" cellpadding="0" class="xheLayout" style="'+(n!="0px"?"width:"+n+";":"")+"height:"+editorHeight+'px;" role="presentation"><tr><td id="'+idTools+'" class="xheTool" unselectable="on" style="height:1px;" role="presentation"></td></tr><tr><td id="'+idIframeArea+'" class="xheIframeArea" role="presentation"><iframe frameborder="0" id="'+idIframe+'" src="javascript:;" style="width:100%;"></iframe></td></tr></table></span>'));_jTools=$("#"+idTools);_jArea=$("#"+idIframeArea);headHTML='<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><link rel="stylesheet" href="'+skinPath+'iframe.css"/>';var a=settings.loadCSS;if(a){if(is(a,"array"))for(var f in a)headHTML+='<link rel="stylesheet" href="'+a[f]+'"/>';else{if(a.match(/\s*<style(\s+[^>]*?)?>[\s\S]+?<\/style>\s*/i))headHTML+=a;else headHTML+='<link rel="stylesheet" href="'+a+'"/>'}}var l="<html><head>"+headHTML+"<title>可视化编辑器,alt+1到9键,切换到工具区,tab键,选择按钮,esc键,返回编辑 "+(settings.readTip?settings.readTip:"")+"</title>";if(r)l+="<style>html{background:"+r+";}</style>";l+='</head><body spellcheck="0" class="editMode'+bodyClass+'"></body></html>';_this.win=_win=$("#"+idIframe)[0].contentWindow;_jWin=$(_win);try{this.doc=_doc=_win.document;_jDoc=$(_doc);_doc.open();_doc.write(l);_doc.close();if(isIE)_doc.body.contentEditable="true";else _doc.designMode="On"}catch(c){}setTimeout(setOpts,300);_this.setSource();_win.setInterval=null;_jTools.append(i.join("")).bind("mousedown contextmenu",returnFalse).click(function(e){var t=$(e.target).closest("a");if(t.is(".xheEnabled")){clearTimeout(timer);_jTools.find("a").attr("tabindex","-1");ev=e;_this.exec(t.attr("cmd"))}return false});_jTools.find(".xheButton").hover(function(e){var t=$(this),n=settings.hoverExecDelay;var r=lastAngle;lastAngle=null;if(n===-1||bDisableHoverExec||!t.is(".xheEnabled"))return false;if(r&&r>10){bDisableHoverExec=true;setTimeout(function(){bDisableHoverExec=false},100);return false}var i=t.attr("cmd"),s=arrTools[i].h===1;if(!s){_this.hidePanel();return false}if(bQuickHoverExec)n=0;if(n>=0)timer=setTimeout(function(){ev=e;lastPoint={x:ev.clientX,y:ev.clientY};_this.exec(i)},n)},function(e){lastPoint=null;if(timer)clearTimeout(timer)}).mousemove(function(e){if(lastPoint){var t={x:e.clientX-lastPoint.x,y:e.clientY-lastPoint.y};if(Math.abs(t.x)>1||Math.abs(t.y)>1){if(t.x>0&&t.y>0){var n=Math.round(Math.atan(t.y/t.x)/.017453293);if(lastAngle)lastAngle=(lastAngle+n)/2;else lastAngle=n}else lastAngle=null;lastPoint={x:e.clientX,y:e.clientY}}}});_jPanel=$("#xhePanel");_jShadow=$("#xheShadow");_jCntLine=$("#xheCntLine");if(_jPanel.length===0){_jPanel=$('<div id="xhePanel"></div>').mousedown(function(e){e.stopPropagation()});_jShadow=$('<div id="xheShadow"></div>');_jCntLine=$('<div id="xheCntLine"></div>');setTimeout(function(){$(document.body).append(_jPanel).append(_jShadow).append(_jCntLine)},10)}$("#"+idContainer).show();_jText.hide();_jArea.css("height",editorHeight-_jTools.outerHeight());if(isIE&browerVer<8)setTimeout(function(){_jArea.css("height",editorHeight-_jTools.outerHeight())},1);_jText.focus(_this.focus);_jForm.submit(saveResult).bind("reset",loadReset);if(settings.submitID)$("#"+settings.submitID).mousedown(saveResult);$(window).bind("unload beforeunload",saveResult).bind("resize",fixFullHeight);$(document).mousedown(clickCancelPanel);if(!bCheckEscInit){$(document).keydown(checkEsc);bCheckEscInit=true}_jWin.focus(function(){if(settings.focus)settings.focus()}).blur(function(){if(settings.blur)settings.blur()});if(isSafari)_jWin.click(fixAppleSel);_jDoc.mousedown(clickCancelPanel).keydown(checkShortcuts).keypress(forcePtag).dblclick(checkDblClick).bind("mousedown click",function(e){_jText.trigger(e.type)});if(isIE){_jDoc.keydown(function(e){var t=_this.getRng();if(e.which===8&&t.item){$(t.item(0)).remove();return false}});function h(e){var t=$(e.target),n;if(n=t.css("width"))t.css("width","").attr("width",n.replace(/[^0-9%]+/g,""));if(n=t.css("height"))t.css("height","").attr("height",n.replace(/[^0-9%]+/g,""))}_jDoc.bind("controlselect",function(e){e=e.target;if(!$.nodeName(e,"IMG"))return;$(e).unbind("resizeend",h).bind("resizeend",h)})}_jDoc.keydown(function(e){var t=e.which;if(e.altKey&&t>=49&&t<=57){_jTools.find("a").attr("tabindex","0");_jTools.find(".xheGStart").eq(t-49).next().find("a").focus();_doc.title="﻿﻿";return false}}).click(function(){_jTools.find("a").attr("tabindex","-1")});_jTools.keydown(function(e){var t=e.which;if(t==27){_jTools.find("a").attr("tabindex","-1");_this.focus()}else if(e.altKey&&t>=49&&t<=57){_jTools.find(".xheGStart").eq(t-49).next().find("a").focus();return false}});var p=$(_doc.documentElement);if(isOpera)p.bind("keydown",function(e){if(e.ctrlKey&&e.which===86)cleanPaste()});else p.bind(isIE?"beforepaste":"paste",cleanPaste);if(settings.disableContextmenu)p.bind("contextmenu",returnFalse);if(settings.html5Upload)p.bind("dragenter dragover",function(e){var t;if((t=e.originalEvent.dataTransfer.types)&&$.inArray("Files",t)!==-1)return false}).bind("drop",function(e){var t=e.originalEvent.dataTransfer,n;if(t&&(n=t.files)&&n.length>0){var r,i,s=["Link","Img","Flash","Media"],o=[],u;for(r in s){i=s[r];if(settings["up"+i+"Url"]&&settings["up"+i+"Url"].match(/^[^!].*/i))o.push(i+":,"+settings["up"+i+"Ext"])}if(o.length===0)return false;else u=o.join(",");function a(e){var t,n,i;for(r=0;r<e.length;r++){n=e[r].name.replace(/.+\./,"");if(t=u.match(new RegExp("(\\w+):[^:]*,"+n+"(?:,|$)","i"))){if(!i)i=t[1];else if(i!==t[1])return 2}else return 1}return i}i=a(n);if(i===1)alert("上传文件的扩展名必需为："+u.replace(/\w+:,/g,""));else if(i===2)alert("每次只能拖放上传同一类型文件");else if(i){_this.startUpload(n,settings["up"+i+"Url"],"*",function(e){var t=[],n,r=settings.onUpload;if(r)r(e);for(var s=0,o=e.length;s<o;s++){n=e[s];url=is(n,"string")?n:n.url;if(url.substr(0,1)==="!")url=url.substr(1);t.push(url)}_this.exec(i);$("#xhe"+i+"Url").val(t.join(" "));$("#xheSave").click()})}return false}});var d=settings.shortcuts;if(d)$.each(d,function(e,t){_this.addShortcuts(e,t)});xCount++;bInit=true;if(settings.fullscreen)_this.toggleFullscreen();else if(settings.sourceMode)setTimeout(_this.toggleSource,20);return true};this.remove=function(){_this.hidePanel();saveResult();_jText.unbind("focus",_this.focus);_jForm.unbind("submit",saveResult).unbind("reset",loadReset);if(settings.submitID)$("#"+settings.submitID).unbind("mousedown",saveResult);$(window).unbind("unload beforeunload",saveResult).unbind("resize",fixFullHeight);$(document).unbind("mousedown",clickCancelPanel);$("#"+idContainer).remove();$("#"+idFixFFCursor).remove();_jText.show();bInit=false};this.saveBookmark=function(){if(!bSource){_this.focus();var e=_this.getRng();e=e.cloneRange?e.cloneRange():e;bookmark={top:_jWin.scrollTop(),rng:e}}};this.loadBookmark=function(){if(bSource||!bookmark)return;_this.focus();var e=bookmark.rng;if(isIE)e.select();else{var t=_this.getSel();t.removeAllRanges();t.addRange(e)}_jWin.scrollTop(bookmark.top);bookmark=null};this.focus=function(){if(!bSource)_win.focus();else $("#sourceCode",_doc).focus();if(isIE){var e=_this.getRng();if(e.parentElement&&e.parentElement().ownerDocument!==_doc)_this.setTextCursor()}return false};this.setTextCursor=function(e){var t=_this.getRng(true),n=_doc.body;if(isIE)t.moveToElementText(n);else{var r=e?"lastChild":"firstChild";while(n.nodeType!=3&&n[r]){n=n[r]}t.selectNode(n)}t.collapse(e?false:true);if(isIE)t.select();else{var i=_this.getSel();i.removeAllRanges();i.addRange(t)}};this.getSel=function(){return _doc.selection?_doc.selection:_win.getSelection()};this.getRng=function(e){var t,n;try{if(!e){t=_this.getSel();n=t.createRange?t.createRange():t.rangeCount>0?t.getRangeAt(0):null}if(!n)n=_doc.body.createTextRange?_doc.body.createTextRange():_doc.createRange()}catch(r){}return n};this.getParent=function(e){var t=_this.getRng(),n;if(!isIE){n=t.commonAncestorContainer;if(!t.collapsed)if(t.startContainer===t.endContainer&&t.startOffset-t.endOffset<2&&t.startContainer.hasChildNodes())n=t.startContainer.childNodes[t.startOffset]}else n=t.item?t.item(0):t.parentElement();e=e?e:"*";n=$(n);if(!n.is(e))n=$(n).closest(e);return n};this.getSelect=function(e){var t=_this.getSel(),n=_this.getRng(),r=true;if(!n||n.item)r=false;else r=!t||n.boundingWidth===0||n.collapsed;if(e==="text")return r?"":n.text||(t.toString?t.toString():"");var i;if(n.cloneContents){var s=$("<div></div>"),o;o=n.cloneContents();if(o)s.append(o);i=s.html()}else if(is(n.item))i=n.item(0).outerHTML;else if(is(n.htmlText))i=n.htmlText;else i=n.toString();if(r)i="";i=_this.processHTML(i,"read");i=_this.cleanHTML(i);i=_this.formatXHTML(i);return i};this.pasteHTML=function(e,t){if(bSource)return false;_this.focus();e=_this.processHTML(e,"write");var n=_this.getSel(),r=_this.getRng();if(t!==undefined){if(r.item){var i=r.item(0);r=_this.getRng(true);r.moveToElementText(i);r.select()}r.collapse(t)}e+="<"+(isIE?"img":"span")+' id="_xhe_temp" width="0" height="0" />';if(r.insertNode){if($(r.startContainer).closest("style,script").length>0)return false;r.deleteContents();r.insertNode(r.createContextualFragment(e))}else{if(n.type.toLowerCase()==="control"){n.clear();r=_this.getRng()}r.pasteHTML(e)}var s=$("#_xhe_temp",_doc),o=s[0];if(isIE){r.moveToElementText(o);r.select()}else{r.selectNode(o);n.removeAllRanges();n.addRange(r)}s.remove()};this.pasteText=function(e,t){if(!e)e="";e=_this.domEncode(e);e=e.replace(/\r?\n/g,"<br />");_this.pasteHTML(e,t)};this.appendHTML=function(e){if(bSource)return false;_this.focus();e=_this.processHTML(e,"write");$(_doc.body).append(e);_this.setTextCursor(true)};this.domEncode=function(e){return e.replace(regEntities,function(e){return arrEntities[e]})};this.setSource=function(e){bookmark=null;if(typeof e!=="string"&&e!=="")e=_text.value;if(bSource)$("#sourceCode",_doc).val(e);else{if(settings.beforeSetSource)e=settings.beforeSetSource(e);e=_this.cleanHTML(e);e=_this.formatXHTML(e);e=_this.processHTML(e,"write");if(isIE){_doc.body.innerHTML='<img id="_xhe_temp" width="0" height="0" />'+e;$("#_xhe_temp",_doc).remove()}else _doc.body.innerHTML=e}};this.processHTML=function(e,t){var n=' class="Apple-style-span"';if(t==="write"){e=e.replace(/(<(\/?)(\w+))((?:\s+[\w\-:]+\s*=\s*(?:"[^"]*"|'[^']*'|[^>\s]+))*)\s*((\/?)>)/g,function(e,t,r,i,s,o,u){i=i.toLowerCase();if(isMozilla){if(i==="strong")i="b";else if(i==="em")i="i"}else if(isSafari){if(i==="strong"){i="span";if(!r)s+=n+' style="font-weight: bold;"'}else if(i==="em"){i="span";if(!r)s+=n+' style="font-style: italic;"'}else if(i==="u"){i="span";if(!r)s+=n+' style="text-decoration: underline;"'}else if(i==="strike"){i="span";if(!r)s+=n+' style="text-decoration: line-through;"'}}var a,f="";if(i==="del")i="strike";else if(i==="img"){s=s.replace(/\s+emot\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/i,function(e,t){a=t.match(/^(["']?)(.*)\1/)[2];a=a.split(",");if(!a[1]){a[1]=a[0];a[0]=""}if(a[0]==="default")a[0]="";return settings.emotMark?e:""})}else if(i==="a"){if(!s.match(/ href=[^ ]/i)&&s.match(/ name=[^ ]/i))f+=" xhe-anchor";if(u)o="></a>"}else if(i==="table"&&!r){var l=s.match(/\s+border\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/i);if(!l||l[1].match(/^(["']?)\s*0\s*\1$/))f+=" xhe-border"}var c;s=s.replace(/\s+([\w\-:]+)\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/g,function(e,t,n){t=t.toLowerCase();n=n.match(/^(["']?)(.*)\1/)[2];aft="";if(isIE&&t.match(/^(disabled|checked|readonly|selected)$/)&&n.match(/^(false|0)$/i))return"";if(i==="img"&&a&&t==="src")return"";if(t.match(/^(src|href)$/)){aft=" _xhe_"+t+'="'+n+'"';if(urlBase)n=getLocalUrl(n,"abs",urlBase)}if(f&&t==="class"){n+=" "+f;f=""}if(isSafari&&t==="style"){if(i==="span"&&n.match(/(^|;)\s*(font-family|font-size|color|background-color)\s*:\s*[^;]+\s*(;|$)/i))c=true}return" "+t+'="'+n+'"'+aft});if(a){var h=emotPath+(a[0]?a[0]:"default")+"/"+a[1]+".gif";s+=' src="'+h+'" _xhe_src="'+h+'"'}if(c)s+=n;if(f)s+=' class="'+f+'"';return"<"+r+i+s+o});if(isIE)e=e.replace(/&apos;/ig,"&#39;");if(!isSafari){function r(e,t,n,r,i,s){var o="",u,a,f,l;u=r.match(/font-family\s*:\s*([^;"]+)/i);if(u)o+=' face="'+u[1]+'"';a=r.match(/font-size\s*:\s*([^;"]+)/i);if(a){a=a[1].toLowerCase();for(var c=0;c<arrFontsize.length;c++)if(a===arrFontsize[c].n||a===arrFontsize[c].s){f=c+1;break}if(f){o+=' size="'+f+'"';r=r.replace(/(^|;)(\s*font-size\s*:\s*[^;"]+;?)+/ig,"$1")}}l=r.match(/(?:^|[\s;])color\s*:\s*([^;"]+)/i);if(l){var h;if(h=l[1].match(/\s*rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i)){l[1]="#";for(var p=1;p<=3;p++){l[1]+=("0"+(h[p]-0).toString(16)).slice(-2)}}l[1]=l[1].replace(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i,"#$1$1$2$2$3$3");o+=' color="'+l[1]+'"'}r=r.replace(/(^|;)(\s*(font-family|color)\s*:\s*[^;"]+;?)+/ig,"$1");if(o!==""){if(r)o+=' style="'+r+'"';return"<font"+(n?n:"")+o+(i?i:"")+">"+s+"</font>"}else return e}e=e.replace(/<(span)(\s+[^>]*?)?\s+style\s*=\s*"((?:[^"]*?;)?\s*(?:font-family|font-size|color)\s*:[^"]*)"( [^>]*)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,r);e=e.replace(/<(span)(\s+[^>]*?)?\s+style\s*=\s*"((?:[^"]*?;)?\s*(?:font-family|font-size|color)\s*:[^"]*)"( [^>]*)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?)<\/\1>/ig,r);e=e.replace(/<(span)(\s+[^>]*?)?\s+style\s*=\s*"((?:[^"]*?;)?\s*(?:font-family|font-size|color)\s*:[^"]*)"( [^>]*)?>(((?!<\1(\s+[^>]*?)?>)[\s\S])*?)<\/\1>/ig,r)}e=e.replace(/<(td|th)(\s+[^>]*?)?>(\s|&nbsp;)*<\/\1>/ig,"<$1$2>"+(isIE?"":"<br />")+"</$1>")}else{if(isSafari){var i=[{r:/font-weight\s*:\s*bold;?/ig,t:"strong"},{r:/font-style\s*:\s*italic;?/ig,t:"em"},{r:/text-decoration\s*:\s*underline;?/ig,t:"u"},{r:/text-decoration\s*:\s*line-through;?/ig,t:"strike"}];function s(e,t,n,r,s){var o=(n?n:"")+(r?r:"");var u=[],a=[];var f,l;for(var c=0;c<i.length;c++){f=i[c].r;l=i[c].t;o=o.replace(f,function(){u.push("<"+l+">");a.push("</"+l+">");return""})}o=o.replace(/\s+style\s*=\s*"\s*"/i,"");return(o?"<span"+o+">":"")+u.join("")+s+a.join("")+(o?"</span>":"")}for(var o=0;o<2;o++){e=e.replace(/<(span)(\s+[^>]*?)?\s+class\s*=\s*"Apple-style-span"(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,s);e=e.replace(/<(span)(\s+[^>]*?)?\s+class\s*=\s*"Apple-style-span"(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?)<\/\1>/ig,s);e=e.replace(/<(span)(\s+[^>]*?)?\s+class\s*=\s*"Apple-style-span"(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S])*?)<\/\1>/ig,s)}}e=e.replace(/(<(\w+))((?:\s+[\w\-:]+\s*=\s*(?:"[^"]*"|'[^']*'|[^>\s]+))*)\s*(\/?>)/g,function(e,t,n,r,i){n=n.toLowerCase();var s;r=r.replace(/\s+_xhe_(?:src|href)\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/i,function(e,t){s=t.match(/^(["']?)(.*)\1/)[2];return""});if(s&&urlType)s=getLocalUrl(s,urlType,urlBase);r=r.replace(/\s+([\w\-:]+)\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/g,function(e,t,n){t=t.toLowerCase();n=n.match(/^(["']?)(.*)\1/)[2].replace(/"/g,"'");if(t==="class"){if(n.match(/^["']?(apple|webkit)/i))return"";n=n.replace(/\s?xhe-[a-z]+/ig,"");if(n==="")return""}else if(t.match(/^((_xhe_|_moz_|_webkit_)|jquery\d+)/i))return"";else if(s&&t.match(/^(src|href)$/i))return" "+t+'="'+s+'"';else if(t==="style"){n=n.replace(/(^|;)\s*(font-size)\s*:\s*([a-z-]+)\s*(;|$)/i,function(e,t,n,r,i){var s,o;for(var u=0;u<arrFontsize.length;u++){s=arrFontsize[u];if(r===s.n){o=s.s;break}}return t+n+":"+o+i})}return" "+t+'="'+n+'"'});if(n==="img"&&!r.match(/\s+alt\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/i))r+=' alt=""';return t+r+i});e=e.replace(/(<(td|th)(?:\s+[^>]*?)?>)\s*([\s\S]*?)(<br(\s*\/)?>)?\s*<\/\2>/ig,function(e,t,n,r){return t+(r?r:"&nbsp;")+"</"+n+">"});e=e.replace(/^\s*(?:<(p|div)(?:\s+[^>]*?)?>)?\s*(<span(?:\s+[^>]*?)?>\s*<\/span>|<br(?:\s+[^>]*?)?>|&nbsp;)*\s*(?:<\/\1>)?\s*$/i,"")}e=e.replace(/(<pre(?:\s+[^>]*?)?>)([\s\S]+?)(<\/pre>)/gi,function(e,t,n,r){return t+n.replace(/<br\s*\/?>/ig,"\r\n")+r});return e};this.getSource=function(e){var t,n=settings.beforeGetSource;if(bSource){t=$("#sourceCode",_doc).val();if(!n)t=_this.formatXHTML(t,false)}else{t=_this.processHTML(_doc.body.innerHTML,"read");t=_this.cleanHTML(t);t=_this.formatXHTML(t,e);if(n)t=n(t)}_text.value=t;return t};this.cleanWord=function(e){var t=settings.cleanPaste;if(t>0&&t<3&&/mso(-|normal)|WordDocument|<table\s+[^>]*?x:str|\s+class\s*=\s*"?xl[67]\d"/i.test(e)){e=e.replace(/<!--[\s\S]*?-->|<!(--)?\[[\s\S]+?\](--)?>|<style(\s+[^>]*?)?>[\s\S]*?<\/style>/ig,"");e=e.replace(/\r?\n/ig,"");if(isIE){e=e.replace(/<v:shapetype(\s+[^>]*)?>[\s\S]*<\/v:shapetype>/ig,"");e=e.replace(/<v:shape(\s+[^>]+)?>[\s\S]*?<v:imagedata(\s+[^>]+)?>\s*<\/v:imagedata>[\s\S]*?<\/v:shape>/ig,function(e,t,n){var r;r=n.match(/\s+src\s*=\s*("[^"]+"|'[^']+'|[^>\s]+)/i);if(r){r=r[1].match(/^(["']?)(.*)\1/)[2];var i='<img src="'+editorRoot+"xheditor_skin/blank.gif"+'" _xhe_temp="true" class="wordImage"';r=t.match(/\s+style\s*=\s*("[^"]+"|'[^']+'|[^>\s]+)/i);if(r){r=r[1].match(/^(["']?)(.*)\1/)[2];i+=' style="'+r+'"'}i+=" />";return i}return""})}else{e=e.replace(/<img( [^<>]*(v:shapes|msohtmlclip)[^<>]*)\/?>/ig,function(e,t){var n,r='<img src="'+editorRoot+"xheditor_skin/blank.gif"+'" _xhe_temp="true" class="wordImage"';n=t.match(/ width\s*=\s*"([^"]+)"/i);if(n)r+=' width="'+n[1]+'"';n=t.match(/ height\s*=\s*"([^"]+)"/i);if(n)r+=' height="'+n[1]+'"';return r+" />"})}e=e.replace(/(<(\/?)([\w\-:]+))((?:\s+[\w\-:]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^>\s]+))?)*)\s*(\/?>)/g,function(e,n,r,i,s,o){i=i.toLowerCase();if(i.match(/^(link)$/)&&s.match(/file:\/\//i)||i.match(/:/)||i==="span"&&t===2)return"";if(!r){s=s.replace(/\s([\w\-:]+)(?:\s*=\s*("[^"]*"|'[^']*'|[^>\s]+))?/ig,function(e,n,r){n=n.toLowerCase();if(/:/.test(n))return"";r=r.match(/^(["']?)(.*)\1/)[2];if(t===1){switch(i){case"p":if(n==="style"){r=r.replace(/"|&quot;/ig,"'").replace(/\s*([^:]+)\s*:\s*(.*?)(;|$)/ig,function(e,t,n){return/^(text-align)$/i.test(t)?t+":"+n+";":""}).replace(/^\s+|\s+$/g,"");return r?" "+n+'="'+r+'"':""}break;case"span":if(n==="style"){r=r.replace(/"|&quot;/ig,"'").replace(/\s*([^:]+)\s*:\s*(.*?)(;|$)/ig,function(e,t,n){return/^(color|background|font-size|font-family)$/i.test(t)?t+":"+n+";":""}).replace(/^\s+|\s+$/g,"");return r?" "+n+'="'+r+'"':""}break;case"table":if(n.match(/^(cellspacing|cellpadding|border|width)$/i))return e;break;case"td":if(n.match(/^(rowspan|colspan)$/i))return e;if(n==="style"){r=r.replace(/"|&quot;/ig,"'").replace(/\s*([^:]+)\s*:\s*(.*?)(;|$)/ig,function(e,t,n){return/^(width|height)$/i.test(t)?t+":"+n+";":""}).replace(/^\s+|\s+$/g,"");return r?" "+n+'="'+r+'"':""}break;case"a":if(n.match(/^(href)$/i))return e;break;case"font":case"img":return e;break}}else if(t===2){switch(i){case"td":if(n.match(/^(rowspan|colspan)$/i))return e;break;case"img":return e}}return""})}return n+s+o});for(var n=0;n<3;n++)e=e.replace(/<([^\s>]+)(\s+[^>]*)?>\s*<\/\1>/g,"");function r(e,t,n){return n}for(var n=0;n<3;n++)e=e.replace(/<(span|a)>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,r);for(var n=0;n<3;n++)e=e.replace(/<(span|a)>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?)<\/\1>/ig,r);for(var n=0;n<3;n++)e=e.replace(/<(span|a)>(((?!<\1(\s+[^>]*?)?>)[\s\S])*?)<\/\1>/ig,r);for(var n=0;n<3;n++)e=e.replace(/<font(\s+[^>]+)><font(\s+[^>]+)>/ig,function(e,t,n){return"<font"+t+n+">"});e=e.replace(/(<(\/?)(tr|td)(?:\s+[^>]+)?>)[^<>]+/ig,function(e,t,n,r){if(!n&&/^td$/i.test(r))return e;else return t})}return e};this.cleanHTML=function(e){e=e.replace(/<!?\/?(DOCTYPE|html|body|meta)(\s+[^>]*?)?>/ig,"");var t;e=e.replace(/<head(?:\s+[^>]*?)?>([\s\S]*?)<\/head>/i,function(e,n){t=n.match(/<(script|style)(\s+[^>]*?)?>[\s\S]*?<\/\1>/ig);return""});if(t)e=t.join("")+e;e=e.replace(/<\??xml(:\w+)?(\s+[^>]*?)?>([\s\S]*?<\/xml>)?/ig,"");if(!settings.internalScript)e=e.replace(/<script(\s+[^>]*?)?>[\s\S]*?<\/script>/ig,"");if(!settings.internalStyle)e=e.replace(/<style(\s+[^>]*?)?>[\s\S]*?<\/style>/ig,"");if(!settings.linkTag||!settings.inlineScript||!settings.inlineStyle)e=e.replace(/(<(\w+))((?:\s+[\w-]+\s*=\s*(?:"[^"]*"|'[^']*'|[^>\s]+))*)\s*(\/?>)/ig,function(e,t,n,r,i){if(!settings.linkTag&&n.toLowerCase()==="link")return"";if(!settings.inlineScript)r=r.replace(/\s+on(?:click|dblclick|mouse(down|up|move|over|out|enter|leave|wheel)|key(down|press|up)|change|select|submit|reset|blur|focus|load|unload)\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/ig,"");if(!settings.inlineStyle)r=r.replace(/\s+(style|class)\s*=\s*("[^"]*"|'[^']*'|[^>\s]+)/ig,"");return t+r+i});e=e.replace(/<\/(strong|b|u|strike|em|i)>((?:\s|<br\/?>|&nbsp;)*?)<\1(\s+[^>]*?)?>/ig,"$2");return e};this.formatXHTML=function(e,t){function T(e){var t={},n=e.split(",");for(var r=0;r<n.length;r++)t[n[r]]=true;return t}function N(e){e=e.toLowerCase();var t=a[e];return t?t:e}function C(e,t,u){if(r[e])while(h.last()&&i[h.last()])k(h.last());if(s[e]&&h.last()===e)k(e);u=n[e]||!!u;if(!u)h.push(e);var a=Array();a.push("<"+e);t.replace(l,function(e,t){t=t.toLowerCase();var n=arguments[2]?arguments[2]:arguments[3]?arguments[3]:arguments[4]?arguments[4]:o[t]?t:"";a.push(" "+t+'="'+n.replace(/"/g,"'")+'"')});a.push((u?" /":"")+">");M(a.join(""),e,true);if(e==="pre")x=true}function k(e){if(!e)var t=0;else for(var t=h.length-1;t>=0;t--)if(h[t]===e)break;if(t>=0){for(var n=h.length-1;n>=t;n--)M("</"+h[n]+">",h[n]);h.length=t}if(e==="pre"){x=false;w--}}function L(e){M(_this.domEncode(e))}function A(e){c.push(e.replace(/^[\s\r\n]+|[\s\r\n]+$/g,""))}function O(e){c.push(e)}function M(e,i,s){if(!x)e=e.replace(/(\t*\r?\n\t*)+/g,"");if(!x&&t===true){if(e.match(/^\s*$/)){c.push(e);return}var o=r[i],u=o?i:"";if(o){if(s)w++;if(E==="")w--}else if(E)w++;if(u!==E||o)_();c.push(e);if(i==="br")_();if(o&&(n[i]||!s))w--;E=o?i:"";S=s}else c.push(e)}function _(){c.push("\r\n");if(w>0){var e=w;while(e--)c.push("	")}}function D(e,t,n,r){if(!n)return r;var i="",s,o,u,a;n=n.replace(/ face\s*=\s*"\s*([^"]*)\s*"/i,function(e,t){if(t)i+="font-family:"+t+";";return""});n=n.replace(/ size\s*=\s*"\s*(\d+)\s*"/i,function(e,t){i+="font-size:"+arrFontsize[(t>7?7:t<1?1:t)-1].s+";";return""});n=n.replace(/ color\s*=\s*"\s*([^"]*)\s*"/i,function(e,t){if(t)i+="color:"+t+";";return""});n=n.replace(/ style\s*=\s*"\s*([^"]*)\s*"/i,function(e,t){if(t)i+=t;return""});n+=' style="'+i+'"';return n?"<span"+n+">"+r+"</span>":r}var n=T("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed");var r=T("address,applet,blockquote,button,center,dd,dir,div,dl,dt,fieldset,form,frameset,h1,h2,h3,h4,h5,h6,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,table,tbody,td,tfoot,th,thead,tr,ul,script");var i=T("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var");var s=T("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr");var o=T("checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected");var u=T("script,style");var a={b:"strong",i:"em",s:"del",strike:"del"};var f=/<(?:\/([^\s>]+)|!([^>]*?)|([\w\-:]+)((?:"[^"]*"|'[^']*'|[^"'<>])*)\s*(\/?))>/g;var l=/\s*([\w\-:]+)(?:\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s]+)))?/g;var c=[],h=[];h.last=function(){return this[this.length-1]};var p,d,v=0,m,g,y,b;var w=-1,E="body",S,x=false;while(p=f.exec(e)){d=p.index;if(d>v){b=e.substring(v,d);if(g)y.push(b);else L(b)}v=f.lastIndex;if(m=p[1]){m=N(m);if(g&&m===g){A(y.join(""));g=null;y=null}if(!g){k(m);continue}}if(g)y.push(p[0]);else{if(m=p[3]){m=N(m);C(m,p[4],p[5]);if(u[m]){g=m;y=[]}}else if(p[2])O(p[0])}}if(e.length>v)L(e.substring(v,e.length));k();e=c.join("");c=null;e=e.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?<\/\1>)*?)<\/\1>/ig,D);e=e.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S]|<\1(\s+[^>]*?)?>((?!<\1(\s+[^>]*?)?>)[\s\S])*?<\/\1>)*?)<\/\1>/ig,D);e=e.replace(/<(font)(\s+[^>]*?)?>(((?!<\1(\s+[^>]*?)?>)[\s\S])*?)<\/\1>/ig,D);e=e.replace(/^(\s*\r?\n)+|(\s*\r?\n)+$/g,"");return e};this.toggleShowBlocktag=function(e){if(bShowBlocktag===e)return;bShowBlocktag=!bShowBlocktag;var t=$(_doc.body);if(bShowBlocktag){bodyClass+=" showBlocktag";t.addClass("showBlocktag")}else{bodyClass=bodyClass.replace(" showBlocktag","");t.removeClass("showBlocktag")}};this.toggleSource=function(e){if(bSource===e)return;_jTools.find("[cmd=Source]").toggleClass("xheEnabled").toggleClass("xheActive");var t=_doc.body,n=$(t),r;var i,s='<span id="_xhe_cursor"></span>',o=0;var u="";if(!bSource){_this.pasteHTML(s,true);r=_this.getSource(true);o=r.indexOf(s);if(!isOpera)o=r.substring(0,o).replace(/\r/g,"").length;r=r.replace(/(\r?\n\s*|)<span id="_xhe_cursor"><\/span>(\s*\r?\n|)/,function(e,t,n){return t&&n?"\r\n":t+n});if(isIE)t.contentEditable="false";else _doc.designMode="Off";n.attr("scroll","no").attr("class","sourceMode").html('<textarea id="sourceCode" wrap="soft" spellcheck="false" style="width:100%;height:100%" />');i=$("#sourceCode",n).blur(_this.getSource)[0];u="可视化编辑"}else{r=_this.getSource();n.html("").removeAttr("scroll").attr("class","editMode"+bodyClass);if(isIE)t.contentEditable="true";else _doc.designMode="On";if(isMozilla){_this._exec("inserthtml","-");$("#"+idFixFFCursor).show().focus().hide()}u="源代码"}bSource=!bSource;_this.setSource(r);_this.focus();if(bSource){if(i.setSelectionRange)i.setSelectionRange(o,o);else{var a=i.createTextRange();a.move("character",o);a.select()}}else _this.setTextCursor();_jTools.find("[cmd=Source]").attr("title",u).find("span").text(u);_jTools.find("[cmd=Source],[cmd=Preview]").toggleClass("xheEnabled");_jTools.find(".xheButton").not("[cmd=Source],[cmd=Fullscreen],[cmd=About]").toggleClass("xheEnabled").attr("aria-disabled",bSource?true:false);setTimeout(setOpts,300)};this.showPreview=function(){var e=settings.beforeSetSource,t=_this.getSource();if(e)t=e(t);var n="<html><head>"+headHTML+"<title>预览</title>"+(urlBase?'<base href="'+urlBase+'"/>':"")+"</head><body>"+t+"</body></html>";var r=window.screen,i=window.open("","xhePreview","toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+Math.round(r.width*.9)+",height="+Math.round(r.height*.8)+",left="+Math.round(r.width*.05)),s=i.document;s.open();s.write(n);s.close();i.focus()};this.toggleFullscreen=function(e){if(bFullscreen===e)return;var t=$("#"+idContainer).find(".xheLayout"),n=$("#"+idContainer),r=jQuery.browser.version,i=isIE&&(r==6||r==7);if(bFullscreen){if(i)_jText.after(n);t.attr("style",sLayoutStyle);_jArea.height(editorHeight-_jTools.outerHeight());$(window).scrollTop(outerScroll);setTimeout(function(){$(window).scrollTop(outerScroll)},10)}else{if(i)$("body").append(n);outerScroll=$(window).scrollTop();sLayoutStyle=t.attr("style");t.removeAttr("style");_jArea.height("100%");setTimeout(fixFullHeight,100)}if(isMozilla){$("#"+idFixFFCursor).show().focus().hide();setTimeout(_this.focus,1)}else if(i)_this.setTextCursor();bFullscreen=!bFullscreen;n.toggleClass("xhe_Fullscreen");$("html").toggleClass("xhe_Fullfix");_jTools.find("[cmd=Fullscreen]").toggleClass("xheActive");setTimeout(setOpts,300)};this.showMenu=function(e,t){var n=$('<div class="xheMenu"></div>'),r=e.length,i=[];$.each(e,function(e,t){if(t.s==="-"){i.push('<div class="xheMenuSeparator"></div>')}else{i.push("<a href=\"javascript:void('"+t.v+'\')" title="'+(t.t?t.t:t.s)+'" v="'+t.v+'" role="option" aria-setsize="'+r+'" aria-posinset="'+(e+1)+'" tabindex="0">'+t.s+"</a>")}});n.append(i.join(""));n.click(function(e){e=e.target;if($.nodeName(e,"DIV"))return;_this.loadBookmark();t($(e).closest("a").attr("v"));_this.hidePanel();return false}).mousedown(returnFalse);_this.saveBookmark();_this.showPanel(n)};this.showColor=function(e){var t=$('<div class="xheColor"></div>'),n=[],r=itemColors.length,i=0;$.each(itemColors,function(e,t){if(i%7===0)n.push((i>0?"</div>":"")+"<div>");n.push("<a href=\"javascript:void('"+t+'\')" xhev="'+t+'" title="'+t+'" style="background:'+t+'" role="option" aria-setsize="'+r+'" aria-posinset="'+(i+1)+'"></a>');i++});n.push("</div>");t.append(n.join(""));t.click(function(t){t=t.target;if(!$.nodeName(t,"A"))return;_this.loadBookmark();e($(t).attr("xhev"));_this.hidePanel();return false}).mousedown(returnFalse);_this.saveBookmark();_this.showPanel(t)};this.showPastetext=function(){var e=$(htmlPastetext),t=$("#xhePastetextValue",e),n=$("#xheSave",e);n.click(function(){_this.loadBookmark();var e=t.val();if(e)_this.pasteText(e);_this.hidePanel();return false});_this.saveBookmark();_this.showDialog(e)};this.showLink=function(){var e=htmlLink,t=_jDoc.find("a[name]").not("[href]"),n=t.length>0;if(n){var r=[];t.each(function(){var e=$(this).attr("name");r.push('<option value="#'+e+'">'+e+"</option>")});e=e.replace(/(<div><label for="xheLinkTarget)/,'<div><label for="xheLinkAnchor">页内锚点: </label><select id="xheLinkAnchor"><option value="">未选择</option>'+r.join("")+"</select></div>$1")}var i=$(e),s=_this.getParent("a"),o=$("#xheLinkText",i),u=$("#xheLinkUrl",i),a=$("#xheLinkTarget",i),f=$("#xheSave",i),l=_this.getSelect();if(n){i.find("#xheLinkAnchor").change(function(){var e=$(this).val();if(e!="")u.val(e)})}if(s.length===1){if(!s.attr("href")){ev=null;return _this.exec("Anchor")}u.val(xheAttr(s,"href"));a.attr("value",s.attr("target"))}else if(l==="")o.val(settings.defLinkText).closest("div").show();if(settings.upLinkUrl)_this.uploadInit(u,settings.upLinkUrl,settings.upLinkExt);f.click(function(){_this.loadBookmark();var e=u.val();if(e===""||s.length===0)_this._exec("unlink");if(e!==""&&e!=="http://"){var t=e.split(" "),n=a.val(),r=o.val();if(t.length>1){_this._exec("unlink");l=_this.getSelect();var i='<a href="xhe_tmpurl"',f,c=[];if(n!=="")i+=' target="'+n+'"';i+=">xhe_tmptext</a>";r=l!==""?l:r?r:e;for(var h=0,p=t.length;h<p;h++){e=t[h];if(e!==""){e=e.split("||");f=i;f=f.replace("xhe_tmpurl",e[0]);f=f.replace("xhe_tmptext",e[1]?e[1]:r);c.push(f)}}_this.pasteHTML(c.join("&nbsp;"))}else{e=t[0].split("||");if(!r)r=e[0];r=e[1]?e[1]:l!==""?"":r?r:e[0];if(s.length===0){if(r)_this.pasteHTML('<a href="#xhe_tmpurl">'+r+"</a>");else _this._exec("createlink","#xhe_tmpurl");s=$('a[href$="#xhe_tmpurl"]',_doc)}else if(r&&!isSafari)s.text(r);xheAttr(s,"href",e[0]);if(n!=="")s.attr("target",n);else s.removeAttr("target")}}_this.hidePanel();return false});_this.saveBookmark();_this.showDialog(i)};this.showAnchor=function(){var e=$(htmlAnchor),t=_this.getParent("a"),n=$("#xheAnchorName",e),r=$("#xheSave",e);if(t.length===1){if(t.attr("href")){ev=null;return _this.exec("Link")}n.val(t.attr("name"))}r.click(function(){_this.loadBookmark();var e=n.val();if(e){if(t.length===0)_this.pasteHTML('<a name="'+e+'"></a>');else t.attr("name",e)}else if(t.length===1)t.remove();_this.hidePanel();return false});_this.saveBookmark();_this.showDialog(e)};this.showImg=function(){var e=$(htmlImg),t=_this.getParent("img"),n=$("#xheImgUrl",e),r=$("#xheImgAlt",e),i=$("#xheImgAlign",e),s=$("#xheImgWidth",e),o=$("#xheImgHeight",e),u=$("#xheImgBorder",e),a=$("#xheImgVspace",e),f=$("#xheImgHspace",e),l=$("#xheSave",e);if(t.length===1){n.val(xheAttr(t,"src"));r.val(t.attr("alt"));i.val(t.attr("align"));s.val(t.attr("width"));o.val(t.attr("height"));u.val(t.attr("border"));var c=t.attr("vspace"),h=t.attr("hspace");a.val(c<=0?"":c);f.val(h<=0?"":h)}if(settings.upImgUrl)_this.uploadInit(n,settings.upImgUrl,settings.upImgExt);l.click(function(){_this.loadBookmark();var e=n.val();if(e!==""&&e!=="http://"){var l=e.split(" "),c=r.val(),h=i.val(),p=s.val(),d=o.val(),v=u.val(),m=a.val(),g=f.val();if(l.length>1){var y='<img src="xhe_tmpurl"',b,w=[];if(c!=="")y+=' alt="'+c+'"';if(h!=="")y+=' align="'+h+'"';if(p!=="")y+=' width="'+p+'"';if(d!=="")y+=' height="'+d+'"';if(v!=="")y+=' border="'+v+'"';if(m!=="")y+=' vspace="'+m+'"';if(g!=="")y+=' hspace="'+g+'"';y+=" />";for(var E in l){e=l[E];if(e!==""){e=e.split("||");b=y;b=b.replace("xhe_tmpurl",e[0]);if(e[1])b='<a href="'+e[1]+'" target="_blank">'+b+"</a>";w.push(b)}}_this.pasteHTML(w.join("&nbsp;"))}else if(l.length===1){e=l[0];if(e!==""){e=e.split("||");if(t.length===0){_this.pasteHTML('<img src="'+e[0]+'#xhe_tmpurl" />');t=$('img[src$="#xhe_tmpurl"]',_doc)}xheAttr(t,"src",e[0]);if(c!=="")t.attr("alt",c);if(h!=="")t.attr("align",h);else t.removeAttr("align");if(p!=="")t.attr("width",p);else t.removeAttr("width");if(d!=="")t.attr("height",d);else t.removeAttr("height");if(v!=="")t.attr("border",v);else t.removeAttr("border");if(m!=="")t.attr("vspace",m);else t.removeAttr("vspace");if(g!=="")t.attr("hspace",g);else t.removeAttr("hspace");if(e[1]){var S=t.parent("a");if(S.length===0){t.wrap("<a></a>");S=t.parent("a")}xheAttr(S,"href",e[1]);S.attr("target","_blank")}}}}else if(t.length===1)t.remove();_this.hidePanel();return false});_this.saveBookmark();_this.showDialog(e)};this.showEmbed=function(e,t,n,r,i,s,o){var u=$(t),a=_this.getParent('embed[type="'+n+'"],embed[classid="'+r+'"]'),f=$("#xhe"+e+"Url",u),l=$("#xhe"+e+"Width",u),c=$("#xhe"+e+"Height",u),h=$("#xheSave",u);if(s)_this.uploadInit(f,s,o);if(a.length===1){f.val(xheAttr(a,"src"));l.val(a.attr("width"));c.val(a.attr("height"))}h.click(function(){_this.loadBookmark();var e=f.val();if(e!==""&&e!=="http://"){var t=l.val(),s=c.val(),o=/^\d+%?$/;if(!o.test(t))t=412;if(!o.test(s))s=300;var u='<embed type="'+n+'" classid="'+r+'" src="xhe_tmpurl"'+i;var h=e.split(" ");if(h.length>1){var p=u+"",d,v=[];p+=' width="xhe_width" height="xhe_height" />';for(var m in h){e=h[m].split("||");d=p;d=d.replace("xhe_tmpurl",e[0]);d=d.replace("xhe_width",e[1]?e[1]:t);d=d.replace("xhe_height",e[2]?e[2]:s);if(e!=="")v.push(d)}_this.pasteHTML(v.join("&nbsp;"))}else if(h.length===1){e=h[0].split("||");if(a.length===0){_this.pasteHTML(u.replace("xhe_tmpurl",e[0]+"#xhe_tmpurl")+" />");a=$('embed[src$="#xhe_tmpurl"]',_doc)}xheAttr(a,"src",e[0]);a.attr("width",e[1]?e[1]:t);a.attr("height",e[2]?e[2]:s)}}else if(a.length===1)a.remove();_this.hidePanel();return false});_this.saveBookmark();_this.showDialog(u)};this.showjwplayer=function(e,t,n,r){var i=$(t),s=_this.getParent('object[type="application/x-shockwave-flash"]'),o=$("#xhe"+e+"Url",i),u=$("#xhe"+e+"Width",i),a=$("#xhe"+e+"Height",i),f=$("#xheSave",i);var l="module_g_form/inc/lib/xheditor/jwplayer/";if(n)_this.uploadInit(o,n,r);if(s.length===1){o.val(xheAttr(s,"src"));u.val(s.attr("width"));a.val(s.attr("height"))}f.click(function(){_this.loadBookmark();var e=o.val();if(e!==""&&e!=="http://"){var t=u.val(),n=a.val(),r=/^\d+%?$/;if(!r.test(t))t=412;if(!r.test(n))n=300;var i=e.split(" ");if(i.length>1){}else if(i.length===1){e=i[0].split("||");var f='<object height="xhe_height" width="xhe_width" data="'+l+'player.swf" type="application/x-shockwave-flash">';f+='<param name="allowfullscreen" value="true">';f+='<param name="allowscriptaccess" value="always">';f+='<param name="seamlesstabbing" value="true">';f+='<param name="wmode" value="opaque">';f+='<param name="flashvars" value="file=xhe_tmpurl&menu=false&allowfullscreen=true&allowscriptaccess=always&wmode=opaque&mute=false&stretching=uniform&autostart=false&skin='+l+'NewTubeDark.zip&controlbar.position=over&dock.position=true&logo.hide=true">';f+="</object>";f=f.replace(/xhe_tmpurl/g,e[0]);f=f.replace(/xhe_width/g,e[1]?e[1]:t);f=f.replace(/xhe_height/g,e[2]?e[2]:n);_this.pasteHTML(f)}}else if(s.length===1)s.remove();_this.hidePanel();return false});_this.saveBookmark();_this.showDialog(i)};this.showEmot=function(e){var t=$('<div class="xheEmot"></div>');e=e?e:selEmotGroup?selEmotGroup:"default";var n=arrEmots[e];var r=emotPath+e+"/",i=0,s=[],o="";var u=n.width,a=n.height,f=n.line,l=n.count,c=n.list;if(l){for(var h=1;h<=l;h++){i++;s.push("<a href=\"javascript:void('"+h+'\')" style="background-image:url('+r+h+'.gif);" emot="'+e+","+h+'" xhev="" title="'+h+'" role="option">&nbsp;</a>');if(i%f===0)s.push("<br />")}}else{$.each(c,function(t,n){i++;s.push("<a href=\"javascript:void('"+n+'\')" style="background-image:url('+r+t+'.gif);" emot="'+e+","+t+'" title="'+n+'" xhev="'+n+'" role="option">&nbsp;</a>');if(i%f===0)s.push("<br />")})}var p=f*(u+12),d=Math.ceil(i/f)*(a+12),v=p*.75;if(d<=v)v="";o=$("<style>"+(v?".xheEmot div{width:"+(p+20)+"px;height:"+v+"px;}":"")+".xheEmot div a{width:"+u+"px;height:"+a+"px;}</style><div>"+s.join("")+"</div>").click(function(e){e=e.target;var t=$(e);if(!$.nodeName(e,"A"))return;_this.loadBookmark();_this.pasteHTML('<img emot="'+t.attr("emot")+'" alt="'+t.attr("xhev")+'">');_this.hidePanel();return false}).mousedown(returnFalse);t.append(o);var m=0,g=['<ul role="tablist">'],y;$.each(arrEmots,function(t,n){m++;g.push("<li"+(e===t?' class="cur"':"")+' role="presentation"><a href="javascript:void(\''+n.name+'\')" group="'+t+'" role="tab" tabindex="0">'+n.name+"</a></li>")});if(m>1){g.push('</ul><br style="clear:both;" />');y=$(g.join("")).click(function(e){selEmotGroup=$(e.target).attr("group");_this.exec("Emot");return false}).mousedown(returnFalse);t.append(y)}_this.saveBookmark();_this.showPanel(t)};this.showTable=function(){var e=$(htmlTable),t=$("#xheTableRows",e),n=$("#xheTableColumns",e),r=$("#xheTableHeaders",e),i=$("#xheTableWidth",e),s=$("#xheTableHeight",e),o=$("#xheTableBorder",e),u=$("#xheTableCellSpacing",e),a=$("#xheTableCellPadding",e),f=$("#xheTableAlign",e),l=$("#xheTableCaption",e),c=$("#xheSave",e);c.click(function(){_this.loadBookmark();var e=l.val(),c=o.val(),h=t.val(),p=n.val(),d=r.val(),v=i.val(),m=s.val(),g=u.val(),y=a.val(),b=f.val();var w,E,S="<table"+(c!==""?' border="'+c+'"':"")+(v!==""?' width="'+v+'"':"")+(m!==""?' height="'+m+'"':"")+(g!==""?' cellspacing="'+g+'"':"")+(y!==""?' cellpadding="'+y+'"':"")+(b!==""?' align="'+b+'"':"")+">";if(e!=="")S+="<caption>"+e+"</caption>";if(d==="row"||d==="both"){S+="<tr>";for(w=0;w<p;w++)S+='<th scope="col"></th>';S+="</tr>";h--}S+="<tbody>";for(w=0;w<h;w++){S+="<tr>";for(E=0;E<p;E++){if(E===0&&(d==="col"||d==="both"))S+='<th scope="row"></th>';else S+="<td></td>"}S+="</tr>"}S+="</tbody></table>";_this.pasteHTML(S);_this.hidePanel();return false});_this.saveBookmark();_this.showDialog(e)};this.showAbout=function(){var e=$(htmlAbout);e.find("p").attr("role","presentation");_this.showDialog(e,true);setTimeout(function(){e.focus()},100)};this.addShortcuts=function(e,t){e=e.toLowerCase();if(arrShortCuts[e]===undefined)arrShortCuts[e]=Array();arrShortCuts[e].push(t)};this.delShortcuts=function(e){delete arrShortCuts[e]};this.uploadInit=function(e,t,n){function f(t){if(is(t,"string"))t=[t];var n=false,r,i=t.length,s,o,u=[],a=settings.onUpload;if(a)a(t);for(r=0;r<i;r++){s=t[r];o=is(s,"string")?s:s.url;if(o.substr(0,1)==="!"){n=true;o=o.substr(1)}u.push(o)}e.val(u.join(" "));if(n)e.closest(".xheDialog").find("#xheSave").click()}var r=$('<span class="xheUpload"><input type="text" style="visibility:hidden;" tabindex="-1" /><input type="button" value="'+settings.upBtnText+'" class="xheBtn" tabindex="-1" /></span>'),i=$(".xheBtn",r);var s=settings.html5Upload,o=s?settings.upMultiple:1;e.after(r);i.before(e);t=t.replace(/{editorRoot}/ig,editorRoot);if(t.substr(0,1)==="!"){i.click(function(){_this.showIframeModal("上传文件",t.substr(1),f,null,null)})}else{r.append('<input type="file"'+(o>1?' multiple=""':"")+' class="xheFile" size="13" name="'+uploadInputname+'" tabindex="-1" />');var u=$(".xheFile",r),a;u.change(function(){a=[];_this.startUpload(u[0],t,n,f)});setTimeout(function(){e.closest(".xheDialog").bind("dragenter dragover",returnFalse).bind("drop",function(e){var r=e.originalEvent.dataTransfer,i;if(s&&r&&(i=r.files)&&i.length>0)_this.startUpload(i,t,n,f);return false})},10)}};this.startUpload=function(fromFiles,toUrl,limitExt,onUploadComplete){function onUploadCallback(sText,bFinish){var data=Object,bOK=false;try{data=eval("("+sText+")")}catch(ex){}if(data.err===undefined||data.msg===undefined)alert(toUrl+" 上传接口发生错误！\r\n\r\n返回的错误内容为: \r\n\r\n"+sText);else{if(data.err)alert(data.err);else{arrMsg.push(data.msg);bOK=true}}if(!bOK||bFinish)_this.removeModal();if(bFinish&&bOK)onUploadComplete(arrMsg);return bOK}var arrMsg=[],bHtml5Upload=settings.html5Upload,upMultiple=bHtml5Upload?settings.upMultiple:1;var upload,fileList,filename,jUploadTip=$('<div style="padding:22px 0;text-align:center;line-height:30px;">文件上传中，请稍候……<br /></div>'),sLoading='<img src="'+skinPath+'img/loading.gif">';if(isOpera||!bHtml5Upload||fromFiles.nodeType&&!((fileList=fromFiles.files)&&fileList[0].name)){if(!checkFileExt(fromFiles.value,limitExt))return;jUploadTip.append(sLoading);upload=new _this.html4Upload(fromFiles,toUrl,onUploadCallback)}else{if(!fileList)fileList=fromFiles;var i,len=fileList.length;if(len>upMultiple){alert("请不要一次上传超过"+upMultiple+"个文件");return}for(i=0;i<len;i++)if(!checkFileExt(fileList[i].name,limitExt))return;var jProgress=$('<div class="xheProgress"><div><span>0%</span></div></div>');jUploadTip.append(jProgress);upload=new _this.html5Upload(uploadInputname,fileList,toUrl,onUploadCallback,function(e){if(e.loaded>=0){var t=Math.round(e.loaded*100/e.total)+"%";$("div",jProgress).css("width",t);$("span",jProgress).text(t+" ( "+formatBytes(e.loaded)+" / "+formatBytes(e.total)+" )")}else jProgress.replaceWith(sLoading)})}_this.showModal("文件上传中(Esc取消上传)",jUploadTip,320,150);upload.start()};this.html4Upload=function(e,t,n){var r=(new Date).getTime(),i="jUploadFrame"+r,s=this;var o=$('<iframe name="'+i+'" class="xheHideArea" />').appendTo("body");var u=$('<form action="'+t+'" target="'+i+'" method="post" enctype="multipart/form-data" class="xheHideArea"></form>').appendTo("body");var a=$(e),f=a.clone().attr("disabled","true");a.before(f).appendTo(u);this.remove=function(){if(s!==null){f.before(a).remove();o.remove();u.remove();s=null}};this.onLoad=function(){var e=o[0].contentWindow.document,t=$(e.body).text();e.write("");s.remove();n(t,true)};this.start=function(){u.submit();o.load(s.onLoad)};return this};this.html5Upload=function(e,t,n,r,i){function h(t,n,r,i){s=new XMLHttpRequest,upload=s.upload;s.onreadystatechange=function(){if(s.readyState===4)r(s.responseText)};if(upload)upload.onprogress=function(e){i(e.loaded)};else i(-1);s.open("POST",n);s.setRequestHeader("Content-Type","application/octet-stream");s.setRequestHeader("Content-Disposition",'attachment; name="'+encodeURIComponent(e)+'"; filename="'+encodeURIComponent(t.name)+'"');if(s.sendAsBinary&&t.getAsBinary)s.sendAsBinary(t.getAsBinary());else s.send(t)}function p(e){if(i)i({loaded:a+e,total:f})}var s,o=0,u=t.length,a=0,f=0,l=this;for(var c=0;c<u;c++)f+=t[c].size;this.remove=function(){if(s){s.abort();s=null}};this.uploadNext=function(e){if(e){a+=t[o-1].size;p(0)}if((!e||e&&r(e,o===u)===true)&&o<u)h(t[o++],n,l.uploadNext,function(e){p(e)})};this.start=function(){l.uploadNext()}};this.showIframeModal=function(title,url,callback,w,h,onRemove){function initModalWin(){try{modalWin.callback=callbackModal;modalWin.unloadme=_this.removeModal;$(modalWin.document).keydown(checkEsc);result=modalWin.name}catch(e){}}function callbackModal(e){modalWin.document.write("");_this.removeModal();if(e!=null)callback(e)}var jContent=$('<iframe frameborder="0" src="'+url.replace(/{editorRoot}/ig,editorRoot)+(/\?/.test(url)?"&":"?")+"parenthost="+location.host+'" style="width:100%;height:100%;display:none;" /><div class="xheModalIfmWait"></div>'),jIframe=jContent.eq(0),jWait=jContent.eq(1);_this.showModal(title,jContent,w,h,onRemove);var modalWin=jIframe[0].contentWindow,result;initModalWin();jIframe.load(function(){initModalWin();if(result){var bResult=true;try{result=eval("("+unescape(result)+")")}catch(e){bResult=false}if(bResult)return callbackModal(result)}if(jWait.is(":visible")){jIframe.show().focus();jWait.remove()}})};this.showModal=function(e,t,n,r,i){if(bShowModal)return false;_this.panelState=bShowPanel;bShowPanel=false;layerShadow=settings.layerShadow;n=n?n:settings.modalWidth;r=r?r:settings.modalHeight;jModal=$('<div class="xheModal" style="width:'+(n-1)+"px;height:"+r+"px;margin-left:-"+Math.ceil(n/2)+"px;"+(isIE&&browerVer<7?"":"margin-top:-"+Math.ceil(r/2)+"px")+'">'+(settings.modalTitle?'<div class="xheModalTitle"><span class="xheModalClose" title="关闭 (Esc)" tabindex="0" role="button"></span>'+e+"</div>":"")+'<div class="xheModalContent"></div></div>').appendTo("body");jOverlay=$('<div class="xheModalOverlay"></div>').appendTo("body");if(layerShadow>0)jModalShadow=$('<div class="xheModalShadow" style="width:'+jModal.outerWidth()+"px;height:"+jModal.outerHeight()+"px;margin-left:-"+(Math.ceil(n/2)-layerShadow-2)+"px;"+(isIE&&browerVer<7?"":"margin-top:-"+(Math.ceil(r/2)-layerShadow-2)+"px")+'"></div>').appendTo("body");$(".xheModalContent",jModal).css("height",r-(settings.modalTitle?$(".xheModalTitle").outerHeight():0)).html(t);if(isIE&&browerVer===6)jHideSelect=$("select:visible").css("visibility","hidden");$(".xheModalClose",jModal).click(_this.removeModal);jOverlay.show();if(layerShadow>0)jModalShadow.show();jModal.show();setTimeout(function(){jModal.find("a,input[type=text],textarea").filter(":visible").filter(function(){return $(this).css("visibility")!=="hidden"}).eq(0).focus()},10);bShowModal=true;onModalRemove=i};this.removeModal=function(){if(jHideSelect)jHideSelect.css("visibility","visible");jModal.html("").remove();if(layerShadow>0)jModalShadow.remove();jOverlay.remove();if(onModalRemove)onModalRemove();bShowModal=false;bShowPanel=_this.panelState};this.showDialog=function(e,t){var n=$('<div class="xheDialog"></div>'),r=$(e),i=$("#xheSave",r);if(i.length===1){r.find("input[type=text],select").keypress(function(e){if(e.which===13){i.click();return false}});r.find("textarea").keydown(function(e){if(e.ctrlKey&&e.which===13){i.click();return false}});i.after(' <input type="button" id="xheCancel" value="取消" />');$("#xheCancel",r).click(_this.hidePanel);if(!settings.clickCancelDialog){bClickCancel=false;var s=$('<div class="xheFixCancel"></div>').appendTo("body").mousedown(returnFalse);var o=_jArea.offset();s.css({left:o.left,top:o.top,width:_jArea.outerWidth(),height:_jArea.outerHeight()})}n.mousedown(function(){bDisableHoverExec=true})}n.append(r);_this.showPanel(n,t)};this.showPanel=function(e,t){if(!ev.target)return false;_jPanel.html("").append(e).css("left",-999).css("top",-999);_jPanelButton=$(ev.target).closest("a").addClass("xheActive");var n=_jPanelButton.offset();var r=n.left,i=n.top;i+=_jPanelButton.outerHeight()-1;_jCntLine.css({left:r+1,top:i,width:_jPanelButton.width()}).show();var s=document.documentElement,o=document.body;if(r+_jPanel.outerWidth()>(window.pageXOffset||s.scrollLeft||o.scrollLeft)+(s.clientWidth||o.clientWidth))r-=_jPanel.outerWidth()-_jPanelButton.outerWidth();var u=settings.layerShadow;if(u>0)_jShadow.css({left:r+u,top:i+u,width:_jPanel.outerWidth(),height:_jPanel.outerHeight()}).show();var a=$("#"+idContainer).offsetParent().css("zIndex");if(a&&!isNaN(a)){_jShadow.css("zIndex",parseInt(a,10)+1);_jPanel.css("zIndex",parseInt(a,10)+2);_jCntLine.css("zIndex",parseInt(a,10)+3)}_jPanel.css({left:r,top:i}).show();if(!t)setTimeout(function(){_jPanel.find("a,input[type=text],textarea").filter(":visible").filter(function(){return $(this).css("visibility")!=="hidden"}).eq(0).focus()},10);bQuickHoverExec=bShowPanel=true};this.hidePanel=function(){if(bShowPanel){_jPanelButton.removeClass("xheActive");_jShadow.hide();_jCntLine.hide();_jPanel.hide();bShowPanel=false;if(!bClickCancel){$(".xheFixCancel").remove();bClickCancel=true}bQuickHoverExec=bDisableHoverExec=false;lastAngle=null;_this.focus();_this.loadBookmark()}};this.exec=function(e){_this.hidePanel();var t=arrTools[e];if(!t)return false;if(ev===null){ev={};var n=_jTools.find(".xheButton[cmd="+e+"]");if(n.length===1)ev.target=n}if(t.e)t.e.call(_this);else{e=e.toLowerCase();switch(e){case"cut":try{_doc.execCommand(e);if(!_doc.queryCommandSupported(e))throw"Error"}catch(r){alert("您的浏览器安全设置不允许使用剪切操作，请使用键盘快捷键(Ctrl + X)来完成")}break;case"copy":try{_doc.execCommand(e);if(!_doc.queryCommandSupported(e))throw"Error"}catch(r){alert("您的浏览器安全设置不允许使用复制操作，请使用键盘快捷键(Ctrl + C)来完成")}break;case"paste":try{_doc.execCommand(e);if(!_doc.queryCommandSupported(e))throw"Error"}catch(r){alert("您的浏览器安全设置不允许使用粘贴操作，请使用键盘快捷键(Ctrl + V)来完成")}break;case"pastetext":if(window.clipboardData)_this.pasteText(window.clipboardData.getData("Text",true));else _this.showPastetext();break;case"blocktag":var i=[];$.each(arrBlocktag,function(e,t){i.push({s:"<"+t.n+">"+t.t+"</"+t.n+">",v:"<"+t.n+">",t:t.t})});_this.showMenu(i,function(e){_this._exec("formatblock",e)});break;case"fontface":var s=[];$.each(arrFontname,function(e,t){t.c=t.c?t.c:t.n;s.push({s:'<span style="font-family:'+t.c+'">'+t.n+"</span>",v:t.c,t:t.n})});_this.showMenu(s,function(e){_this._exec("fontname",e)});break;case"fontsize":var o=[];$.each(arrFontsize,function(e,t){o.push({s:'<span style="font-size:'+t.s+';">'+t.t+"("+t.s+")</span>",v:e+1,t:t.t})});_this.showMenu(o,function(e){_this._exec("fontsize",e)});break;case"fontcolor":_this.showColor(function(e){_this._exec("forecolor",e)});break;case"backcolor":_this.showColor(function(e){if(isIE)_this._exec("backcolor",e);else{setCSS(true);_this._exec("hilitecolor",e);setCSS(false)}});break;case"align":_this.showMenu(menuAlign,function(e){_this._exec(e)});break;case"list":_this.showMenu(menuList,function(e){_this._exec(e)});break;case"link":_this.showLink();break;case"anchor":_this.showAnchor();break;case"img":_this.showImg();break;case"flash":_this.showEmbed("Flash",htmlFlash,"application/x-shockwave-flash","clsid:d27cdb6e-ae6d-11cf-96b8-4445535400000",' wmode="opaque" quality="high" menu="false" play="true" loop="true" allowfullscreen="true"',settings.upFlashUrl,settings.upFlashExt);break;case"media":_this.showjwplayer("Media",htmlMedia,settings.upMediaUrl,settings.upMediaExt);break;case"hr":_this.pasteHTML("<hr />");break;case"emot":_this.showEmot();break;case"table":_this.showTable();break;case"source":_this.toggleSource();break;case"preview":_this.showPreview();break;case"print":_win.print();break;case"fullscreen":_this.toggleFullscreen();break;case"about":_this.showAbout();break;default:_this._exec(e);break}}ev=null};this._exec=function(e,t,n){if(!n)_this.focus();var r;if(t!==undefined)r=_doc.execCommand(e,false,t);else r=_doc.execCommand(e,false,null);return r};};xheditor.settings={skin:"default",tools:"full",clickCancelDialog:true,linkTag:false,internalScript:false,inlineScript:false,internalStyle:true,inlineStyle:true,showBlocktag:false,forcePtag:true,upLinkExt:"zip,rar,txt",upImgExt:"jpg,jpeg,gif,png",upFlashExt:"swf",upMediaExt:"wmv,avi,wma,mp3,mid",modalWidth:350,modalHeight:220,modalTitle:true,defLinkText:"点击打开链接",layerShadow:3,emotMark:false,upBtnText:"上传",cleanPaste:1,hoverExecDelay:100,html5Upload:true,upMultiple:99};window.xheditor=xheditor;$(function(){$.fn.oldVal=$.fn.val;$.fn.val=function(e){var t=this,n;if(e===undefined)if(t[0]&&(n=t[0].xheditor))return n.getSource();else return t.oldVal();return t.each(function(){if(n=this.xheditor)n.setSource(e);else t.oldVal(e)})};$("textarea").each(function(){var e=$(this),t=e.attr("class");if(t&&(t=t.match(/(?:^|\s)xheditor(?:\-(m?full|simple|mini))?(?:\s|$)/i)))e.xheditor(t[1]?{tools:t[1]}:null)})})})(jQuery)